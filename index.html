<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Công Việc (Tabs Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện hỗ trợ xuất PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .task-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border-top-color: #4f46e5; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #export-content { display: none; }
        .tag-input-anim { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; width: 0; } to { opacity: 1; width: 80px; } }

        /* Styles cho Tabs */
        .tab-btn {
            white-space: nowrap;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom-width: 2px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-active {
            border-color: #4f46e5; /* Indigo-600 */
            color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        .tab-inactive {
            border-color: transparent;
            color: #6b7280; /* Gray-500 */
        }
        .tab-inactive:hover {
            border-color: #d1d5db; /* Gray-300 */
            color: #374151; /* Gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-4 px-3 sm:px-6 lg:px-8">

    <div class="max-w-3xl mx-auto">
        
        <!-- Status Banner -->
        <div id="status-banner" class="hidden mb-4 p-3 rounded-lg flex items-center justify-between text-sm shadow-sm transition-all">
            <span id="status-text" class="font-medium flex items-center"></span>
            <button onclick="retryConnection()" id="retry-btn" class="hidden underline ml-2 text-xs">Thử kết nối lại</button>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-5 mb-5 relative overflow-hidden">
            <div id="header-bar" class="absolute top-0 left-0 w-1 h-full bg-gray-300 transition-colors duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i id="header-icon" class="fas fa-circle-notch fa-spin text-gray-400 mr-2 transition-colors"></i>
                        Todo <span id="mode-label" class="ml-1">App</span>
                    </h1>
                    <p class="text-xs text-gray-500 mt-1" id="current-date">Đang khởi động...</p>
                    <p class="text-[10px] text-gray-400 mt-0.5 flex items-center gap-1">
                        <i class="fas fa-database text-indigo-500"></i>
                        ID: <span id="data-id-display" class="font-mono font-bold ml-1">...</span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <!-- Nút Xuất Báo Cáo -->
                    <button onclick="openExportModal()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg hover:bg-indigo-100 hover:text-indigo-700 transition flex items-center shadow-sm border border-indigo-100" title="Xuất báo cáo">
                        <i class="fas fa-file-export mr-1"></i> Xuất
                    </button>
                    <!-- Nút Thông Báo -->
                    <button onclick="requestNotificationPermission()" id="btn-notify" class="text-xs bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-bell"></i>
                    </button>
                </div>
            </div>

            <!-- Form Thêm Mới -->
            <form id="todo-form" class="space-y-3">
                <div class="relative">
                    <input type="text" id="task-input" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 pl-4 pr-24 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Nhập công việc cần làm..." required>
                    <!-- Auto-Tag Indicator -->
                    <div id="auto-tag-badge" class="absolute right-2 top-3 hidden">
                         <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded font-semibold border border-indigo-200 shadow-sm flex items-center">
                            <i class="fas fa-tag mr-1 text-[10px]"></i> <span id="auto-tag-name"></span>
                         </span>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1 relative">
                        <div class="flex gap-2">
                            <input type="text" id="tags-input" list="tag-suggestions" class="flex-1 border border-gray-200 bg-gray-50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Thẻ (tag1, tag2)">
                            <select id="tag-select" onchange="selectTagFromDropdown(this)" class="w-1/3 border border-gray-200 bg-white text-gray-600 rounded-lg px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                <option value="">+ Tag</option>
                            </select>
                        </div>
                        <datalist id="tag-suggestions"></datalist>
                        <div id="quick-tags" class="flex flex-wrap gap-2 mt-2 min-h-[24px]"></div>
                    </div>
                    <div class="w-full sm:w-40">
                        <input type="time" id="alert-time" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-600">
                    </div>
                </div>

                <button type="submit" id="btn-add" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200 flex justify-center items-center disabled:opacity-50">
                    <i class="fas fa-plus mr-2"></i> Thêm Công Việc
                </button>
            </form>
        </div>

        <!-- === TABS SECTION (NEW) === -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4 overflow-hidden">
            <div class="flex items-center justify-between px-2 bg-gray-50 border-b border-gray-200">
                <!-- Tab Container Scrollable -->
                <div id="tabs-container" class="flex items-center overflow-x-auto no-scrollbar flex-1 mr-2 space-x-1">
                    <!-- Tabs injected by JS -->
                </div>
                
                <!-- Tab Settings Button -->
                <button onclick="openTabManager()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full transition shrink-0" title="Quản lý Tab">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Filter Info (if tab is selected but we want to know exact filter) -->
        <div id="filter-status-bar" class="hidden mb-3 flex items-center justify-between text-xs text-gray-500 px-1">
            <span>Đang hiển thị tab: <strong class="text-indigo-600" id="current-tab-name">Tất cả</strong></span>
            <button onclick="resetToAll()" class="hover:text-indigo-600 underline">Xem tất cả</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center py-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
        </div>

        <!-- SECTION: Đang thực hiện -->
        <div class="mb-2 flex items-center justify-between">
            <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide border-b-2 border-indigo-100 pb-1">Cần làm (<span id="count-todo">0</span>)</h2>
        </div>
        <div id="todo-list" class="space-y-3 mb-8 min-h-[50px]"></div>

        <!-- SECTION: Đã hoàn thành -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <div class="mb-4 flex items-center justify-between cursor-pointer hover:bg-gray-100 p-2 rounded-lg transition" onclick="toggleCompletedSection()">
                <h2 class="text-sm font-bold text-green-700 uppercase tracking-wide flex items-center">
                    <span class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center mr-2">
                        <i id="toggle-icon" class="fas fa-check text-xs"></i>
                    </span>
                    Đã hoàn thành (<span id="count-done">0</span>)
                </h2>
                <button onclick="clearAllCompleted(event)" class="text-xs text-red-500 hover:text-red-700 hover:underline px-2 py-1 rounded">
                    <i class="fas fa-trash-alt mr-1"></i>Xóa tất cả
                </button>
            </div>
            
            <div id="completed-list" class="space-y-2 opacity-75 bg-gray-50 p-4 rounded-xl hidden"></div>
        </div>
    </div>

    <!-- === TAB MANAGER MODAL === -->
    <div id="tab-manager-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-[slideIn_0.2s_ease-out]">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-th-list text-indigo-600 mr-2"></i>Quản lý Tab
            </h3>
            <p class="text-xs text-gray-500 mb-4">Chọn các Tag bạn muốn hiển thị thành Tab truy cập nhanh.</p>
            
            <div id="tab-manager-list" class="space-y-2 max-h-60 overflow-y-auto mb-4">
                <!-- Checkboxes injected here -->
            </div>

            <div class="flex justify-end pt-2">
                <button onclick="closeTabManager()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-bold">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- === EDIT MODAL === -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 animate-[slideIn_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-edit text-indigo-600 mr-2"></i>Chỉnh sửa</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">Nội dung</label>
                    <input type="text" id="edit-task-text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">Giờ nhắc</label>
                    <input type="time" id="edit-task-time" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-xs font-semibold text-gray-500 mb-2">Quản lý Tags</label>
                    <div id="edit-tags-list" class="flex flex-wrap gap-2 mb-3 min-h-[30px]"></div>
                    <div class="flex gap-2">
                        <input type="text" id="edit-new-tag" class="flex-1 border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Nhập tag mới...">
                        <button onclick="addTagInEdit()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3 border-t pt-4">
                <button onclick="closeEditModal()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm font-medium">Hủy bỏ</button>
                <button onclick="saveTaskEdit()" id="btn-save-edit" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm font-bold shadow-lg flex items-center">
                    <i class="fas fa-save mr-2"></i> Lưu
                </button>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-[slideIn_0.2s_ease-out]">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-file-export text-indigo-600 mr-2"></i> Xuất Báo Cáo
            </h3>
            
            <div id="export-filter-notice" class="hidden mb-4 bg-indigo-50 border border-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs flex items-center">
                <i class="fas fa-filter mr-2"></i>
                <span>Đang xuất dữ liệu theo Tab: <strong id="export-filter-tag-name">...</strong></span>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Từ ngày</label>
                        <input type="date" id="export-start" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Đến ngày</label>
                        <input type="date" id="export-end" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-2">Định dạng</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="export-format" value="pdf" class="peer sr-only" checked>
                            <div class="border-2 border-gray-200 rounded-lg p-2 text-center peer-checked:border-red-500 peer-checked:bg-red-50 transition"><i class="fas fa-file-pdf text-red-500 text-xl mb-1 block"></i><span class="text-xs font-medium">PDF</span></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="export-format" value="doc" class="peer sr-only">
                            <div class="border-2 border-gray-200 rounded-lg p-2 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 transition"><i class="fas fa-file-word text-blue-500 text-xl mb-1 block"></i><span class="text-xs font-medium">Word</span></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="export-format" value="html" class="peer sr-only">
                            <div class="border-2 border-gray-200 rounded-lg p-2 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition"><i class="fas fa-code text-orange-500 text-xl mb-1 block"></i><span class="text-xs font-medium">HTML</span></div>
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeExportModal()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm font-medium">Hủy</button>
                <button onclick="performExport()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-bold shadow-lg flex items-center">
                    <i class="fas fa-download mr-2"></i> Tải về
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Export Template -->
    <div id="export-template" class="hidden">
        <div class="p-8 font-sans bg-white">
            <div class="border-b-2 border-gray-800 pb-4 mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Báo Cáo Công Việc</h1>
                <p class="text-gray-600 mt-2">Nguồn: <span id="exp-user">...</span></p>
                <p class="text-gray-600">Ngày xuất: <span id="exp-time"></span></p>
                <p class="text-gray-600">Phạm vi: <span id="exp-range"></span></p>
                <p class="text-gray-600 hidden" id="exp-tag-filter">Tab: <span class="font-bold text-indigo-600" id="exp-tag-name"></span></p>
            </div>
            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 p-2 text-left w-10">#</th>
                        <th class="border border-gray-300 p-2 text-left">Nội dung</th>
                        <th class="border border-gray-300 p-2 text-left w-32">Tags</th>
                        <th class="border border-gray-300 p-2 text-left w-24">Trạng thái</th>
                        <th class="border border-gray-300 p-2 text-left w-32">Ngày tạo</th>
                    </tr>
                </thead>
                <tbody id="exp-tbody"></tbody>
            </table>
            <div class="mt-8 text-right text-xs text-gray-400"><p>Generated by Todo App Hybrid</p></div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CẤU HÌNH ---
        const DATA_APP_ID = 'my-todo-app'; 
        const STORAGE_KEY_TABS = 'todo_pinned_tabs_' + DATA_APP_ID;

        const firebaseConfig = {
            apiKey: "AIzaSyABja0AYV5E_n0UgtMyICjVHyBMsevlyqU",
            authDomain: "clipboard-aca15.firebaseapp.com",
            projectId: "clipboard-aca15",
            storageBucket: "clipboard-aca15.firebasestorage.app",
            messagingSenderId: "886054305884",
            appId: "1:886054305884:web:1cc0497875be8ad364a699"
        };

        let app, auth, db;
        let isOfflineMode = false;
        let currentUser = null;
        let allTodos = []; 
        let availableTags = new Set();
        
        // --- TAB STATE ---
        let currentTagFilter = ""; // "" = All, otherwise Tag Name
        let pinnedTabs = []; // Array of strings (Tag names)

        // Editing State
        let currentEditingId = null;
        let tempEditingTags = [];

        // DOM Refs
        const todoForm = document.getElementById('todo-form');
        const taskInput = document.getElementById('task-input');
        const tagsInput = document.getElementById('tags-input');
        const tagSelect = document.getElementById('tag-select');
        const tagSuggestions = document.getElementById('tag-suggestions');
        const alertTimeInput = document.getElementById('alert-time');
        const todoListEl = document.getElementById('todo-list');
        const completedListEl = document.getElementById('completed-list');
        const quickTagsEl = document.getElementById('quick-tags');
        const loadingIndicator = document.getElementById('loading-indicator');
        const btnAdd = document.getElementById('btn-add');
        const userIdDisplay = document.getElementById('data-id-display');
        const tabsContainer = document.getElementById('tabs-container');
        const autoTagBadge = document.getElementById('auto-tag-badge');
        const autoTagName = document.getElementById('auto-tag-name');

        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
        }

        function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                loadPinnedTabs(); // Load tabs from local storage

                signInAnonymously(auth).catch((error) => {
                    console.warn("Offline Mode trigger:", error.message);
                    switchToOfflineMode("Chế độ Offline");
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        switchToOnlineMode();
                    }
                });
            } catch (e) {
                switchToOfflineMode("Chế độ Offline (Lỗi khởi tạo)");
            }
        }

        // --- TABS LOGIC ---
        function loadPinnedTabs() {
            const stored = localStorage.getItem(STORAGE_KEY_TABS);
            if (stored) {
                pinnedTabs = JSON.parse(stored);
            } else {
                pinnedTabs = []; // Default empty
            }
        }

        function savePinnedTabs() {
            localStorage.setItem(STORAGE_KEY_TABS, JSON.stringify(pinnedTabs));
            renderTabsUI();
        }

        function renderTabsUI() {
            tabsContainer.innerHTML = '';

            // 1. Tab "Tất cả" (luôn ở đầu)
            const allBtn = document.createElement('button');
            allBtn.className = `tab-btn ${currentTagFilter === "" ? 'tab-active' : 'tab-inactive'}`;
            allBtn.textContent = "Tất cả";
            allBtn.onclick = () => switchTab("");
            tabsContainer.appendChild(allBtn);

            // 2. Các Pinned Tabs
            pinnedTabs.forEach(tag => {
                // Chỉ hiển thị nếu tag này thực sự tồn tại trong dữ liệu HOẶC user đã pin nó
                const btn = document.createElement('button');
                btn.className = `tab-btn ${currentTagFilter === tag ? 'tab-active' : 'tab-inactive'}`;
                btn.textContent = tag;
                btn.onclick = () => switchTab(tag);
                tabsContainer.appendChild(btn);
            });
        }

        function switchTab(tagName) {
            currentTagFilter = tagName;
            renderTabsUI();
            renderLists();
            
            // Cập nhật UI thông báo filter status
            const filterBar = document.getElementById('filter-status-bar');
            const currentTabName = document.getElementById('current-tab-name');
            if (tagName) {
                filterBar.classList.remove('hidden');
                currentTabName.textContent = tagName;
                // Hiển thị badge auto-tag trong ô input
                autoTagBadge.classList.remove('hidden');
                autoTagName.textContent = tagName;
            } else {
                filterBar.classList.add('hidden');
                autoTagBadge.classList.add('hidden');
            }
        }

        window.resetToAll = function() {
            switchTab("");
        }

        // --- TAB MANAGER ---
        window.openTabManager = function() {
            const modal = document.getElementById('tab-manager-modal');
            const list = document.getElementById('tab-manager-list');
            list.innerHTML = '';
            
            // Lấy tất cả tag unique, sort alphabet
            const allTags = Array.from(availableTags).sort();

            if (allTags.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 italic">Chưa có tag nào trong hệ thống.</p>';
            } else {
                allTags.forEach(tag => {
                    const isPinned = pinnedTabs.includes(tag);
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-2 hover:bg-gray-50 rounded border border-gray-100";
                    div.innerHTML = `
                        <span class="text-sm text-gray-700">${tag}</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="togglePinTag('${tag}')" ${isPinned ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    `;
                    list.appendChild(div);
                });
            }
            modal.classList.remove('hidden');
        }

        window.closeTabManager = function() {
            document.getElementById('tab-manager-modal').classList.add('hidden');
        }

        window.togglePinTag = function(tag) {
            if (pinnedTabs.includes(tag)) {
                pinnedTabs = pinnedTabs.filter(t => t !== tag);
            } else {
                pinnedTabs.push(tag);
            }
            savePinnedTabs();
        }

        // --- FIREBASE & DATA LOGIC ---

        function switchToOnlineMode() {
            isOfflineMode = false;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('header-bar').className = "absolute top-0 left-0 w-1 h-full bg-purple-600 transition-colors duration-500";
            document.getElementById('header-icon').className = "fas fa-globe text-purple-600 mr-2";
            document.getElementById('header-icon').classList.remove('fa-spin');
            userIdDisplay.textContent = DATA_APP_ID;
            userIdDisplay.classList.add("text-purple-600");
            userIdDisplay.classList.remove("text-orange-500");
            document.getElementById('status-banner').classList.add('hidden');
            
            setupRealtimeListener();
        }

        function switchToOfflineMode(reason) {
            isOfflineMode = true;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('header-bar').className = "absolute top-0 left-0 w-1 h-full bg-orange-500 transition-colors duration-500";
            document.getElementById('header-icon').className = "fas fa-database text-orange-500 mr-2";
            document.getElementById('header-icon').classList.remove('fa-spin');
            userIdDisplay.textContent = DATA_APP_ID + " (Offline)";
            userIdDisplay.classList.add("text-orange-500");
            userIdDisplay.classList.remove("text-purple-600");
            
            const banner = document.getElementById('status-banner');
            banner.classList.remove('hidden');
            banner.className = "mb-4 p-3 rounded-lg flex items-center justify-between text-sm shadow-sm bg-orange-50 border border-orange-200 text-orange-700";
            document.getElementById('status-text').innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${reason}`;
            document.getElementById('retry-btn').classList.remove('hidden');
            
            loadOfflineData();
        }

        window.retryConnection = function() { location.reload(); }

        function setupRealtimeListener() {
            const q = query(collection(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                processSnapshotData(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.error(error);
                if (!isOfflineMode) switchToOfflineMode("Mất kết nối dữ liệu.");
            });
        }

        function loadOfflineData() {
            const localData = JSON.parse(localStorage.getItem('todos_offline_' + DATA_APP_ID)) || [];
            localData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            processSnapshotData(localData);
        }

        function processSnapshotData(dataArray) {
            allTodos = dataArray;
            availableTags.clear();
            allTodos.forEach((todo) => {
                if (todo.tags) todo.tags.forEach(tag => availableTags.add(tag));
            });
            updateTagSelectors();
            renderTabsUI(); // Refresh tabs in case availableTags changed
            renderLists();
        }

        function renderLists() {
            todoListEl.innerHTML = '';
            completedListEl.innerHTML = '';
            
            // Lọc dữ liệu dựa trên currentTagFilter (Active Tab)
            const filteredTodos = currentTagFilter 
                ? allTodos.filter(t => t.tags && t.tags.includes(currentTagFilter))
                : allTodos;

            let todoCount = 0;
            let doneCount = 0;

            filteredTodos.forEach((todo) => {
                if (todo.completed) {
                    doneCount++;
                    renderTodoItem(todo, completedListEl, true);
                } else {
                    todoCount++;
                    renderTodoItem(todo, todoListEl, false);
                }
            });

            document.getElementById('count-todo').textContent = todoCount;
            document.getElementById('count-done').textContent = doneCount;
        }

        // --- CORE ACTIONS ---

        async function addTodo(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            if (!text) return;
            
            btnAdd.disabled = true;
            btnAdd.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const tagsText = tagsInput.value.trim();
            let tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag !== "") : [];
            
            // AUTO TAGGING: Nếu đang ở Tab nào đó (khác Tất cả), tự động thêm tag đó
            if (currentTagFilter && !tags.includes(currentTagFilter)) {
                tags.push(currentTagFilter);
            }

            const newTodoData = {
                text: text, completed: false, createdAt: new Date().toISOString(),
                alertTime: alertTimeInput.value || null, tags: tags
            };
            
            try {
                if (isOfflineMode) {
                    const newTodo = { id: Date.now().toString(), ...newTodoData };
                    allTodos.unshift(newTodo);
                    saveToLocalStorage();
                    processSnapshotData(allTodos);
                    showToast("Đã lưu (Offline)!", "success");
                } else {
                    await addDoc(collection(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos'), newTodoData);
                    showToast("Đã lưu lên Cloud!", "success");
                }
                taskInput.value = ''; tagsInput.value = ''; alertTimeInput.value = '';
            } catch (err) {
                if (!isOfflineMode) switchToOfflineMode("Lỗi ghi. Chuyển Offline.");
            } finally {
                btnAdd.disabled = false;
                btnAdd.innerHTML = '<i class="fas fa-plus mr-2"></i> Thêm Công Việc';
            }
        }

        // --- HELPER FUNCTIONS ---
        function saveToLocalStorage() { localStorage.setItem('todos_offline_' + DATA_APP_ID, JSON.stringify(allTodos)); }

        function renderTodoItem(todo, container, isCompleted) {
            const tagsHtml = (todo.tags || []).map(tag => `
                <span class="inline-flex items-center bg-blue-50 text-blue-600 text-[10px] font-semibold px-2 py-0.5 rounded border border-blue-100 mr-1 group relative">
                    #${tag}
                    <button onclick="event.stopPropagation(); removeTag('${todo.id}', '${tag}')" class="ml-1 text-blue-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none"><i class="fas fa-times"></i></button>
                </span>
            `).join('');
            
            const addTagBtn = `<button onclick="event.stopPropagation(); startAddTag(this, '${todo.id}')" class="inline-flex items-center text-[10px] text-gray-400 hover:text-indigo-600 border border-transparent hover:border-indigo-100 hover:bg-indigo-50 px-1 rounded transition"><i class="fas fa-plus"></i></button>`;
            const alertHtml = todo.alertTime ? `<span class="inline-flex items-center text-[10px] ${isCompleted ? 'text-gray-400' : 'text-orange-600 bg-orange-50'} px-2 py-0.5 rounded mr-1"><i class="fas fa-clock mr-1"></i> ${todo.alertTime}</span>` : '';
            const createdTimeHtml = `<span class="text-[10px] text-gray-400 ml-1 inline-flex items-center"><i class="far fa-calendar-alt mr-1"></i>${formatDate(todo.createdAt)}</span>`;
            
            const el = document.createElement('div');
            // Edit/Delete Buttons
            const actions = `
                <div class="flex items-center ${isCompleted ? '' : 'opacity-0 group-hover:opacity-100 transition'}">
                     <button onclick="openEditModal('${todo.id}')" class="text-gray-300 hover:text-blue-500 p-2 rounded-full transition mr-1"><i class="fas fa-edit"></i></button>
                     <button class="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition delete-btn" data-id="${todo.id}"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;

            if (isCompleted) {
                el.className = "group flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200 transition hover:shadow-sm";
                el.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1 overflow-hidden opacity-60 group-hover:opacity-100 transition-opacity">
                        <button class="text-green-600 hover:text-green-700 transition focus:outline-none toggle-btn" data-id="${todo.id}" data-status="false"><i class="fas fa-check-square text-lg"></i></button>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-500 line-through text-sm truncate">${todo.text}</p>
                            <div class="flex mt-1 opacity-50 grayscale flex-wrap items-center">${tagsHtml}${addTagBtn}${createdTimeHtml}</div>
                        </div>
                    </div>
                    ${actions}`;
            } else {
                el.className = "task-enter bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex items-start justify-between group transition-all hover:shadow-md hover:translate-y-[-2px]";
                el.innerHTML = `
                    <div class="flex items-start space-x-3 flex-1 overflow-hidden">
                        <button class="mt-0.5 text-gray-300 hover:text-green-500 transition focus:outline-none toggle-btn" data-id="${todo.id}" data-status="true"><i class="far fa-square text-xl"></i></button>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-800 font-medium text-base leading-tight break-words">${todo.text}</p>
                            <div class="flex flex-wrap items-center mt-2 gap-y-1">${alertHtml}${tagsHtml}${addTagBtn}${createdTimeHtml}</div>
                        </div>
                    </div>
                    ${actions}`;
            }
            el.querySelector('.toggle-btn').addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; const newStatus = e.currentTarget.dataset.status === "true"; toggleTodoStatus(id, newStatus); });
            el.querySelector('.delete-btn').addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; deleteTodo(id); });
            container.appendChild(el);
        }

        async function toggleTodoStatus(id, isCompleted) {
            try {
                if (isOfflineMode) {
                    const idx = allTodos.findIndex(t => t.id === id);
                    if (idx > -1) { allTodos[idx].completed = isCompleted; saveToLocalStorage(); processSnapshotData(allTodos); }
                } else {
                    await updateDoc(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', id), { completed: isCompleted });
                }
                showToast(isCompleted ? "Đã xong!" : "Đã mở lại", "success");
            } catch (err) { showToast("Lỗi cập nhật", "error"); }
        }

        async function deleteTodo(id) {
            if (!confirm("Xóa công việc này?")) return;
            try {
                if (isOfflineMode) {
                    allTodos = allTodos.filter(t => t.id !== id); saveToLocalStorage(); processSnapshotData(allTodos);
                } else {
                    await deleteDoc(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', id));
                }
                showToast("Đã xóa", "info");
            } catch (err) { showToast("Lỗi xóa", "error"); }
        }
        
        // --- TAG & FILTER UPDATES ---
        function updateTagSelectors() {
            tagSuggestions.innerHTML = ''; tagSelect.innerHTML = '<option value="">+ Tag</option>'; quickTagsEl.innerHTML = '';
            if (availableTags.size > 0) {
                const sortedTags = Array.from(availableTags).sort();
                sortedTags.forEach(tag => {
                    const opt = document.createElement('option'); opt.value = tag; tagSuggestions.appendChild(opt);
                    const selectOpt = document.createElement('option'); selectOpt.value = tag; selectOpt.textContent = tag; tagSelect.appendChild(selectOpt);
                    const tagBtn = document.createElement('button'); tagBtn.type = "button";
                    tagBtn.className = "text-xs bg-white border border-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50 transition";
                    tagBtn.textContent = tag; tagBtn.onclick = () => addTagToInput(tag); quickTagsEl.appendChild(tagBtn);
                });
            } else { quickTagsEl.innerHTML = '<span class="text-xs text-gray-400 italic">Chưa có thẻ.</span>'; }
        }
        
        window.selectTagFromDropdown = function(selectEl) { const val = selectEl.value; if (val) { addTagToInput(val); selectEl.value = ""; } }
        function addTagToInput(tag) { const current = tagsInput.value; if (current) { const existingTags = current.split(',').map(t => t.trim()); if (!existingTags.includes(tag)) tagsInput.value = current + ", " + tag; } else { tagsInput.value = tag; } }
        
        window.removeTag = async function(id, tagToRemove) {
            const todo = allTodos.find(t => t.id === id); if (!todo) return;
            const newTags = (todo.tags || []).filter(t => t !== tagToRemove);
            try {
                if (isOfflineMode) { const idx = allTodos.findIndex(t => t.id === id); if (idx > -1) { allTodos[idx].tags = newTags; saveToLocalStorage(); processSnapshotData(allTodos); } }
                else { await updateDoc(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', id), { tags: newTags }); }
            } catch (err) { showToast("Lỗi xóa tag", "error"); }
        }
        
        window.startAddTag = function(btn, id) {
            const inputHtml = `<input type="text" id="quick-tag-input-${id}" class="tag-input-anim text-[10px] border border-indigo-300 rounded px-1.5 py-0.5 outline-none w-20" placeholder="Tag..." onkeydown="handleTagKey(event, '${id}')" onblur="confirmAddTag('${id}', this)">`;
            btn.outerHTML = inputHtml;
            setTimeout(() => { const input = document.getElementById(`quick-tag-input-${id}`); if(input) input.focus(); }, 50);
        }
        window.handleTagKey = function(e, id) { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } else if (e.key === 'Escape') { e.target.value = ''; e.target.blur(); } }
        window.confirmAddTag = async function(id, inputEl) {
            const newTag = inputEl.value.trim();
            if (!newTag) { renderLists(); return; }
            const todo = allTodos.find(t => t.id === id); if (!todo) return;
            const currentTags = todo.tags || [];
            if (currentTags.includes(newTag)) { showToast("Tag đã có!", "warning"); renderLists(); return; }
            const newTags = [...currentTags, newTag];
            try {
                if (isOfflineMode) { const idx = allTodos.findIndex(t => t.id === id); if (idx > -1) { allTodos[idx].tags = newTags; saveToLocalStorage(); processSnapshotData(allTodos); } }
                else { await updateDoc(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', id), { tags: newTags }); }
                showToast("Đã thêm tag", "success");
            } catch (err) { showToast("Lỗi thêm tag", "error"); renderLists(); }
        }

        // --- EXPORT ---
        window.openExportModal = function() {
            const modal = document.getElementById('export-modal');
            document.getElementById('export-start').valueAsDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            document.getElementById('export-end').valueAsDate = new Date();
            
            const filterNotice = document.getElementById('export-filter-notice');
            if (currentTagFilter) {
                filterNotice.classList.remove('hidden');
                document.getElementById('export-filter-tag-name').textContent = currentTagFilter;
            } else {
                filterNotice.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }
        window.closeExportModal = function() { document.getElementById('export-modal').classList.add('hidden'); }
        window.performExport = function() {
            const startDate = new Date(document.getElementById('export-start').value);
            const endDate = new Date(document.getElementById('export-end').value); endDate.setHours(23,59,59,999);
            const format = document.querySelector('input[name="export-format"]:checked').value;
            
            const filteredData = allTodos.filter(t => {
                const tDate = new Date(t.createdAt);
                const matchDate = tDate >= startDate && tDate <= endDate;
                const matchTag = currentTagFilter ? (t.tags && t.tags.includes(currentTagFilter)) : true;
                return matchDate && matchTag;
            });
            
            if (filteredData.length === 0) { showToast("Không có dữ liệu!", "error"); return; }
            
            document.getElementById('exp-user').textContent = isOfflineMode ? "Offline" : DATA_APP_ID;
            document.getElementById('exp-time').textContent = new Date().toLocaleString('vi-VN');
            document.getElementById('exp-range').textContent = `${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')}`;
            if(currentTagFilter) { document.getElementById('exp-tag-filter').classList.remove('hidden'); document.getElementById('exp-tag-name').textContent = currentTagFilter; }
            else { document.getElementById('exp-tag-filter').classList.add('hidden'); }

            const tbody = document.getElementById('exp-tbody'); tbody.innerHTML = '';
            filteredData.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt)).forEach((t, i) => {
                const tr = document.createElement('tr'); tr.className = i%2===0?'bg-white':'bg-gray-50';
                tr.innerHTML = `<td class="border p-2 text-center border-gray-300">${i+1}</td><td class="border p-2 border-gray-300">${t.text}</td><td class="border p-2 text-xs border-gray-300 text-gray-600">${(t.tags||[]).join(', ')}</td><td class="border p-2 text-xs border-gray-300 ${t.completed?'text-green-600':'text-orange-600'}">${t.completed?'Xong':'Đang làm'}</td><td class="border p-2 text-xs border-gray-300">${new Date(t.createdAt).toLocaleDateString('vi-VN')}</td>`;
                tbody.appendChild(tr);
            });
            
            const element = document.getElementById('export-template'); element.classList.remove('hidden');
            const fName = `Report_${DATA_APP_ID}_${new Date().getTime()}`;
            
            if (format === 'pdf') {
                html2pdf().set({ margin: 10, filename: fName+'.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(element).save().then(()=>{ element.classList.add('hidden'); closeExportModal(); showToast("Xuất PDF xong!", "success"); });
            } else {
                const mime = format==='doc'?'application/vnd.ms-word':'text/html';
                const source = 'data:'+mime+';charset=utf-8,' + encodeURIComponent(element.innerHTML);
                const dl = document.createElement("a"); dl.href = source; dl.download = fName+(format==='doc'?'.doc':'.html');
                dl.click(); element.classList.add('hidden'); closeExportModal(); showToast("Tải xong!", "success");
            }
        }

        // --- EDIT MODAL ---
        window.openEditModal = function(id) {
            const task = allTodos.find(t => t.id === id); if (!task) return;
            currentEditingId = id; tempEditingTags = [...(task.tags || [])];
            document.getElementById('edit-task-text').value = task.text;
            document.getElementById('edit-task-time').value = task.alertTime || "";
            document.getElementById('edit-new-tag').value = "";
            renderEditTags(); document.getElementById('edit-modal').classList.remove('hidden');
        }
        window.closeEditModal = function() { document.getElementById('edit-modal').classList.add('hidden'); currentEditingId = null; }
        window.renderEditTags = function() {
            const c = document.getElementById('edit-tags-list'); c.innerHTML = '';
            tempEditingTags.forEach((tag, i) => {
                const b = document.createElement('div'); b.className = 'bg-indigo-100 text-indigo-700 text-xs font-semibold px-2 py-1 rounded flex items-center';
                b.innerHTML = `<span class="mr-1">#${tag}</span><button onclick="removeTagFromEdit(${i})" class="text-indigo-400 hover:text-red-500"><i class="fas fa-times"></i></button>`;
                c.appendChild(b);
            });
        }
        window.removeTagFromEdit = function(i) { tempEditingTags.splice(i, 1); renderEditTags(); }
        window.addTagInEdit = function() { const v = document.getElementById('edit-new-tag').value.trim(); if(v && !tempEditingTags.includes(v)) { tempEditingTags.push(v); renderEditTags(); document.getElementById('edit-new-tag').value=''; } }
        window.saveTaskEdit = async function() {
            if (!currentEditingId) return;
            const newText = document.getElementById('edit-task-text').value.trim();
            if(!newText) return showToast("Trống nội dung!", "error");
            const updateData = { text: newText, alertTime: document.getElementById('edit-task-time').value || null, tags: tempEditingTags };
            try {
                if(isOfflineMode) { const i = allTodos.findIndex(t => t.id === currentEditingId); if(i>-1) { allTodos[i] = {...allTodos[i], ...updateData}; saveToLocalStorage(); processSnapshotData(allTodos); } }
                else { await updateDoc(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', currentEditingId), updateData); }
                closeEditModal(); showToast("Đã sửa", "success");
            } catch(e) { showToast("Lỗi sửa", "error"); }
        }
        window.clearAllCompleted = async function(e) {
            e.stopPropagation();
            const completed = allTodos.filter(t => t.completed); if(!completed.length) return;
            if(!confirm(`Xóa ${completed.length} mục đã xong?`)) return;
            try {
                if(isOfflineMode) { allTodos = allTodos.filter(t => !t.completed); saveToLocalStorage(); processSnapshotData(allTodos); }
                else { const batch = writeBatch(db); completed.forEach(t => batch.delete(doc(db, 'artifacts', DATA_APP_ID, 'public', 'data', 'todos', t.id))); await batch.commit(); }
                showToast("Đã dọn dẹp", "info");
            } catch(e) { showToast("Lỗi dọn dẹp", "error"); }
        }

        // --- UTILS ---
        window.toggleCompletedSection = function() { document.getElementById('completed-list').classList.toggle('hidden'); }
        window.requestNotificationPermission = function() { if (!("Notification" in window)) return alert("Trình duyệt không hỗ trợ"); Notification.requestPermission().then(p => { if (p === "granted") showToast("Đã bật thông báo", "success"); }); }
        window.showToast = function(msg, type = 'info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); const bg = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800'; t.className = `${bg} text-white px-4 py-3 rounded shadow-lg flex items-center space-x-2 text-sm transform transition-all duration-300 translate-x-full opacity-0`; t.innerHTML = `<span>${msg}</span>`; c.appendChild(t); setTimeout(() => t.classList.remove('translate-x-full', 'opacity-0'), 10); setTimeout(() => { t.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => t.remove(), 300); }, 3000); }
        setInterval(() => { const now = new Date(); if (now.getSeconds() > 5) return; const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; allTodos.forEach(t => { if (!t.completed && t.alertTime === timeStr) { if (Notification.permission === "granted") new Notification("Nhắc nhở", { body: t.text }); showToast(`Đến giờ: ${t.text}`, "warning"); } }); }, 5000);

        todoForm.addEventListener('submit', addTodo);
        initApp(); 
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    </script>
</body>
</html>

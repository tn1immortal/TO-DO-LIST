<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Công Việc (Hybrid)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .task-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border-top-color: #4f46e5; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-4 px-3 sm:px-6 lg:px-8">

    <div class="max-w-3xl mx-auto">
        
        <!-- Status Banner -->
        <div id="status-banner" class="hidden mb-4 p-3 rounded-lg flex items-center justify-between text-sm shadow-sm transition-all">
            <span id="status-text" class="font-medium flex items-center"></span>
            <button onclick="retryConnection()" id="retry-btn" class="hidden underline ml-2 text-xs">Thử kết nối lại</button>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-5 mb-5 relative overflow-hidden">
            <div id="header-bar" class="absolute top-0 left-0 w-1 h-full bg-gray-300 transition-colors duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i id="header-icon" class="fas fa-circle-notch fa-spin text-gray-400 mr-2 transition-colors"></i>
                        Todo <span id="mode-label" class="ml-1">App</span>
                    </h1>
                    <p class="text-xs text-gray-500 mt-1" id="current-date">Đang khởi động...</p>
                    <p class="text-[10px] text-gray-400 mt-0.5">ID: <span id="user-id-display">...</span></p>
                </div>
                <button onclick="requestNotificationPermission()" id="btn-notify" class="text-xs bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 transition">
                    <i class="fas fa-bell"></i>
                </button>
            </div>

            <!-- Form -->
            <form id="todo-form" class="space-y-3">
                <input type="text" id="task-input" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Nhập công việc cần làm..." required>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1 relative">
                        <div class="flex gap-2">
                            <!-- Input Tag có hỗ trợ Datalist -->
                            <input type="text" id="tags-input" list="tag-suggestions" class="flex-1 border border-gray-200 bg-gray-50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Thẻ (hoặc chọn bên phải)">
                            <!-- Dropdown chọn Tag cũ -->
                            <select id="tag-select" onchange="selectTagFromDropdown(this)" class="w-1/3 border border-gray-200 bg-white text-gray-600 rounded-lg px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                <option value="">Chọn tag...</option>
                            </select>
                        </div>
                        
                        <!-- Datalist ẩn để gợi ý khi gõ -->
                        <datalist id="tag-suggestions"></datalist>

                        <!-- Quick Tags Chips (Hiển thị các tag phổ biến) -->
                        <div id="quick-tags" class="flex flex-wrap gap-2 mt-2 min-h-[24px]">
                            <!-- Tags chips sẽ hiện ở đây -->
                        </div>
                    </div>
                    <div class="w-full sm:w-40">
                        <input type="time" id="alert-time" class="w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-600">
                    </div>
                </div>

                <button type="submit" id="btn-add" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200 flex justify-center items-center disabled:opacity-50">
                    <i class="fas fa-plus mr-2"></i> Thêm Công Việc
                </button>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center py-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
        </div>

        <!-- SECTION: Đang thực hiện -->
        <div class="mb-2 flex items-center justify-between">
            <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide border-b-2 border-indigo-100 pb-1">Cần làm (<span id="count-todo">0</span>)</h2>
        </div>
        <div id="todo-list" class="space-y-3 mb-8 min-h-[50px]"></div>

        <!-- SECTION: Đã hoàn thành (Tách biệt rõ ràng) -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <div class="mb-4 flex items-center justify-between cursor-pointer hover:bg-gray-100 p-2 rounded-lg transition" onclick="toggleCompletedSection()">
                <h2 class="text-sm font-bold text-green-700 uppercase tracking-wide flex items-center">
                    <span class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center mr-2">
                        <i id="toggle-icon" class="fas fa-check text-xs"></i>
                    </span>
                    Đã hoàn thành (<span id="count-done">0</span>)
                </h2>
                <button onclick="clearAllCompleted(event)" class="text-xs text-red-500 hover:text-red-700 hover:underline px-2 py-1 rounded">
                    <i class="fas fa-trash-alt mr-1"></i>Xóa tất cả
                </button>
            </div>
            
            <!-- Danh sách đã hoàn thành -->
            <div id="completed-list" class="space-y-2 opacity-75 bg-gray-50 p-4 rounded-xl hidden">
                <!-- Items render here -->
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Config Của Bạn ---
        const firebaseConfig = {
            apiKey: "AIzaSyApbQ_ZEH-Is0rpr1gektLBNtuX2-2dtmc",
            authDomain: "dong-bo-data.firebaseapp.com",
            databaseURL: "https://dong-bo-data-default-rtdb.firebaseio.com",
            projectId: "dong-bo-data",
            storageBucket: "dong-bo-data.firebasestorage.app",
            messagingSenderId: "435238492536",
            appId: "1:435238492536:web:b44b601b8e2595c57e108d",
            measurementId: "G-YFN6XNFJ5G"
        };

        // --- Global State ---
        let app, auth, db;
        let isOfflineMode = false;
        let currentUser = null;
        let allTodos = []; 
        let availableTags = new Set();
        const appId = 'my-todo-app'; 

        // --- DOM Elements ---
        const todoForm = document.getElementById('todo-form');
        const taskInput = document.getElementById('task-input');
        const tagsInput = document.getElementById('tags-input');
        const tagSelect = document.getElementById('tag-select');
        const tagSuggestions = document.getElementById('tag-suggestions');
        const alertTimeInput = document.getElementById('alert-time');
        const todoListEl = document.getElementById('todo-list');
        const completedListEl = document.getElementById('completed-list');
        const quickTagsEl = document.getElementById('quick-tags');
        const loadingIndicator = document.getElementById('loading-indicator');
        const btnAdd = document.getElementById('btn-add');
        const userIdDisplay = document.getElementById('user-id-display');
        const statusBanner = document.getElementById('status-banner');
        const statusText = document.getElementById('status-text');
        const retryBtn = document.getElementById('retry-btn');
        const headerIcon = document.getElementById('header-icon');
        const headerBar = document.getElementById('header-bar');
        const modeLabel = document.getElementById('mode-label');

        // --- Helper: Format Date ---
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('vi-VN', { 
                hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' 
            });
        }

        // --- INITIALIZATION FLOW ---
        function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Thử đăng nhập - Xử lý lỗi Silent (không log đỏ console nếu là lỗi config)
                signInAnonymously(auth).catch((error) => {
                    // Kiểm tra mã lỗi để xử lý mượt mà
                    if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                        console.warn("Firebase Auth chưa được bật. Chuyển sang chế độ Offline."); // Dùng warn thay vì error
                        switchToOfflineMode("Chế độ Offline (Cloud chưa cấu hình)");
                    } else if (error.code === 'auth/network-request-failed') {
                        console.warn("Lỗi mạng. Chuyển sang chế độ Offline.");
                        switchToOfflineMode("Chế độ Offline (Không có mạng)");
                    } else {
                         console.error("Lỗi xác thực khác:", error);
                         switchToOfflineMode("Chế độ Offline (Lỗi xác thực)");
                    }
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Đã đăng nhập:", user.uid);
                        currentUser = user;
                        switchToOnlineMode();
                    }
                });

            } catch (e) {
                console.error("Lỗi khởi tạo:", e);
                switchToOfflineMode("Chế độ Offline (Lỗi khởi tạo)");
            }
        }

        // --- MODE SWITCHING ---

        function switchToOnlineMode() {
            if (!isOfflineMode && currentUser) {
                 // Đã online, chỉ update UI nếu cần
            }
            isOfflineMode = false;
            loadingIndicator.classList.add('hidden');
            
            // UI Updates
            headerBar.className = "absolute top-0 left-0 w-1 h-full bg-green-500 transition-colors duration-500";
            headerIcon.className = "fas fa-cloud text-green-500 mr-2";
            headerIcon.classList.remove('fa-spin');
            modeLabel.textContent = "Cloud";
            userIdDisplay.textContent = currentUser.uid.substring(0, 8) + "...";
            userIdDisplay.classList.remove("text-orange-500");
            
            // Status Banner
            statusBanner.classList.add('hidden');

            setupRealtimeListener(currentUser.uid);
            showToast("Đã kết nối Cloud!", "success");
        }

        function switchToOfflineMode(reason) {
            if (isOfflineMode) return; // Prevent double init
            isOfflineMode = true;
            loadingIndicator.classList.add('hidden');

            // UI Updates
            headerBar.className = "absolute top-0 left-0 w-1 h-full bg-orange-500 transition-colors duration-500";
            headerIcon.className = "fas fa-database text-orange-500 mr-2";
            headerIcon.classList.remove('fa-spin');
            modeLabel.textContent = "Offline";
            userIdDisplay.textContent = "Lưu trên máy này";
            userIdDisplay.classList.add("text-orange-500");

            // Status Banner
            statusBanner.classList.remove('hidden');
            statusBanner.className = "mb-4 p-3 rounded-lg flex items-center justify-between text-sm shadow-sm transition-all bg-orange-50 border border-orange-200 text-orange-700";
            statusText.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${reason}`;
            retryBtn.classList.remove('hidden');

            loadOfflineData();
        }

        window.retryConnection = function() {
            location.reload();
        }

        // --- DATA LOGIC (HYBRID) ---

        // 1. Load Data
        function setupRealtimeListener(userId) {
            // Nếu đang offline thì không gọi Firestore để tránh lỗi thừa
            if (isOfflineMode) return;

            const q = query(
                collection(db, 'artifacts', appId, 'users', userId, 'todos'),
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                processSnapshotData(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.warn("Firestore Warning:", error.message);
                // Fallback nếu mất kết nối giữa chừng
                if(!isOfflineMode) switchToOfflineMode("Mất kết nối dữ liệu. Đã chuyển sang Offline.");
            });
        }

        function loadOfflineData() {
            const localData = JSON.parse(localStorage.getItem('todos_offline')) || [];
            // Sort by createdAt desc
            localData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            processSnapshotData(localData);
        }

        function processSnapshotData(dataArray) {
            allTodos = dataArray;
            availableTags.clear();
            
            todoListEl.innerHTML = '';
            completedListEl.innerHTML = '';
            
            let todoCount = 0;
            let doneCount = 0;

            allTodos.forEach((todo) => {
                if (todo.tags && Array.isArray(todo.tags)) {
                    todo.tags.forEach(tag => availableTags.add(tag));
                }

                if (todo.completed) {
                    doneCount++;
                    renderTodoItem(todo, completedListEl, true);
                } else {
                    todoCount++;
                    renderTodoItem(todo, todoListEl, false);
                }
            });

            document.getElementById('count-todo').textContent = todoCount;
            document.getElementById('count-done').textContent = doneCount;
            updateTagSelectors();
        }

        // 2. Add Data
        async function addTodo(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            if (!text) return;

            btnAdd.disabled = true;
            btnAdd.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const tagsText = tagsInput.value.trim();
            const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag !== "") : [];

            const newTodoData = {
                text: text,
                completed: false,
                createdAt: new Date().toISOString(),
                alertTime: alertTimeInput.value || null,
                tags: tags
            };

            try {
                if (isOfflineMode) {
                    // Offline Logic
                    const newTodo = { id: Date.now().toString(), ...newTodoData };
                    allTodos.unshift(newTodo);
                    saveToLocalStorage();
                    processSnapshotData(allTodos); // Re-render
                    showToast("Đã lưu (Offline)!", "success");
                } else {
                    // Online Logic
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'todos'), newTodoData);
                    showToast("Đã lưu lên Cloud!", "success");
                }
                
                // Reset Form
                taskInput.value = '';
                tagsInput.value = '';
                alertTimeInput.value = '';
                
            } catch (err) {
                console.error(err);
                showToast("Lỗi khi thêm việc", "error");
                // Nếu lỗi khi ghi online, switch offline
                if (!isOfflineMode) switchToOfflineMode("Lỗi ghi dữ liệu. Chuyển sang Offline.");
            } finally {
                btnAdd.disabled = false;
                btnAdd.innerHTML = '<i class="fas fa-plus mr-2"></i> Thêm Công Việc';
            }
        }

        // 3. Update Data
        async function toggleTodoStatus(id, isCompleted) {
            try {
                if (isOfflineMode) {
                    const idx = allTodos.findIndex(t => t.id === id);
                    if (idx > -1) {
                        allTodos[idx].completed = isCompleted;
                        saveToLocalStorage();
                        processSnapshotData(allTodos);
                        showToast(isCompleted ? "Đã xong!" : "Đã mở lại", "success");
                    }
                } else {
                    if (!currentUser) return;
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id);
                    await updateDoc(docRef, { completed: isCompleted });
                    showToast(isCompleted ? "Đã xong!" : "Đã mở lại", "success");
                }
            } catch (err) {
                console.error(err);
                showToast("Lỗi cập nhật", "error");
            }
        }

        // 4. Delete Data
        async function deleteTodo(id) {
            if (!confirm("Bạn có chắc muốn xóa?")) return;
            try {
                if (isOfflineMode) {
                    allTodos = allTodos.filter(t => t.id !== id);
                    saveToLocalStorage();
                    processSnapshotData(allTodos);
                    showToast("Đã xóa (Offline)", "info");
                } else {
                    if (!currentUser) return;
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id);
                    await deleteDoc(docRef);
                    showToast("Đã xóa trên Cloud", "info");
                }
            } catch (err) {
                console.error(err);
                showToast("Lỗi khi xóa", "error");
            }
        }

        // 5. Batch Delete
        window.clearAllCompleted = async function(event) {
            event.stopPropagation();
            const completedTodos = allTodos.filter(t => t.completed);
            if (completedTodos.length === 0) return;

            if(!confirm(`Xóa vĩnh viễn ${completedTodos.length} công việc đã xong?`)) return;

            try {
                if (isOfflineMode) {
                    allTodos = allTodos.filter(t => !t.completed);
                    saveToLocalStorage();
                    processSnapshotData(allTodos);
                    showToast("Đã dọn dẹp (Offline)", "info");
                } else {
                    if (!currentUser) return;
                    const batch = writeBatch(db);
                    completedTodos.forEach(t => {
                        const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', t.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    showToast("Đã dọn dẹp trên Cloud", "info");
                }
            } catch (err) {
                showToast("Lỗi xóa hàng loạt", "error");
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('todos_offline', JSON.stringify(allTodos));
        }

        // --- Rendering (Shared) ---
        function renderTodoItem(todo, container, isCompleted) {
            const tagsHtml = (todo.tags || []).map(tag => 
                `<span class="inline-block bg-blue-50 text-blue-600 text-[10px] font-semibold px-2 py-0.5 rounded border border-blue-100 mr-1">#${tag}</span>`
            ).join('');

            const alertHtml = todo.alertTime 
                ? `<span class="inline-flex items-center text-[10px] ${isCompleted ? 'text-gray-400' : 'text-orange-600 bg-orange-50'} px-2 py-0.5 rounded mr-1">
                    <i class="fas fa-clock mr-1"></i> ${todo.alertTime}
                   </span>` 
                : '';
            
            const createdTimeHtml = `<span class="text-[10px] text-gray-400 ml-1 inline-flex items-center" title="Thời gian tạo"><i class="far fa-calendar-alt mr-1"></i>${formatDate(todo.createdAt)}</span>`;

            const el = document.createElement('div');
            
            if (isCompleted) {
                el.className = "group flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200 transition hover:shadow-sm";
                el.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1 overflow-hidden opacity-60 group-hover:opacity-100 transition-opacity">
                        <button class="text-green-600 hover:text-green-700 transition focus:outline-none toggle-btn" data-id="${todo.id}" data-status="false" title="Đánh dấu chưa xong">
                            <i class="fas fa-check-square text-lg"></i>
                        </button>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-500 line-through text-sm truncate">${todo.text}</p>
                            <div class="flex mt-1 opacity-50 grayscale flex-wrap items-center">
                                ${tagsHtml}
                                ${createdTimeHtml}
                            </div>
                        </div>
                    </div>
                    <button class="text-gray-300 hover:text-red-500 p-2 rounded-full transition delete-btn" data-id="${todo.id}" title="Xóa vĩnh viễn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                el.className = "task-enter bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex items-start justify-between group transition-all hover:shadow-md hover:translate-y-[-2px]";
                el.innerHTML = `
                    <div class="flex items-start space-x-3 flex-1 overflow-hidden">
                        <button class="mt-0.5 text-gray-300 hover:text-green-500 transition focus:outline-none toggle-btn" data-id="${todo.id}" data-status="true" title="Đánh dấu hoàn thành">
                            <i class="far fa-square text-xl"></i>
                        </button>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-800 font-medium text-base leading-tight break-words">${todo.text}</p>
                            <div class="flex flex-wrap items-center mt-2 gap-y-1">
                                ${alertHtml}
                                ${tagsHtml}
                                ${createdTimeHtml}
                            </div>
                        </div>
                    </div>
                    <button class="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition opacity-0 group-hover:opacity-100 delete-btn" data-id="${todo.id}" title="Xóa">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
            }

            el.querySelector('.toggle-btn').addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const newStatus = e.currentTarget.dataset.status === "true";
                toggleTodoStatus(id, newStatus);
            });
            el.querySelector('.delete-btn').addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                deleteTodo(id);
            });

            container.appendChild(el);
        }

        // --- Tag & UI Utilities ---
        function updateTagSelectors() {
            tagSuggestions.innerHTML = '';
            tagSelect.innerHTML = '<option value="">Chọn tag...</option>';
            quickTagsEl.innerHTML = '';

            if (availableTags.size > 0) {
                const sortedTags = Array.from(availableTags).sort();
                sortedTags.forEach(tag => {
                    const opt = document.createElement('option');
                    opt.value = tag;
                    tagSuggestions.appendChild(opt);

                    const selectOpt = document.createElement('option');
                    selectOpt.value = tag;
                    selectOpt.textContent = tag;
                    tagSelect.appendChild(selectOpt);

                    const tagBtn = document.createElement('button');
                    tagBtn.type = "button";
                    tagBtn.className = "text-xs bg-white border border-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50 transition";
                    tagBtn.textContent = tag;
                    tagBtn.onclick = () => addTagToInput(tag);
                    quickTagsEl.appendChild(tagBtn);
                });
            } else {
                quickTagsEl.innerHTML = '<span class="text-xs text-gray-400 italic">Chưa có thẻ nào được tạo.</span>';
            }
        }

        window.selectTagFromDropdown = function(selectEl) {
            const val = selectEl.value;
            if (val) {
                addTagToInput(val);
                selectEl.value = ""; 
            }
        }

        function addTagToInput(tag) {
            const current = tagsInput.value;
            if (current) {
                const existingTags = current.split(',').map(t => t.trim());
                if (!existingTags.includes(tag)) tagsInput.value = current + ", " + tag;
            } else {
                tagsInput.value = tag;
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('vi-VN', options);
        }

        window.toggleCompletedSection = function() {
            const list = document.getElementById('completed-list');
            list.classList.toggle('hidden');
        }
        
        window.requestNotificationPermission = function() {
             if (!("Notification" in window)) {
                alert("Trình duyệt không hỗ trợ thông báo");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") showToast("Đã bật thông báo", "success");
            });
        }

        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgClass = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800';
            toast.className = `${bgClass} text-white px-4 py-3 rounded shadow-lg flex items-center space-x-2 text-sm transform transition-all duration-300 translate-x-full opacity-0`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Alert System ---
        setInterval(() => {
            const now = new Date();
            if (now.getSeconds() > 5) return; 
            
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            allTodos.forEach(todo => {
                if (!todo.completed && todo.alertTime === currentTimeStr) {
                    if (Notification.permission === "granted") {
                        new Notification("Nhắc nhở công việc", { body: todo.text });
                    }
                    showToast(`Đến giờ: ${todo.text}`, "warning");
                }
            });
        }, 5000);

        todoForm.addEventListener('submit', addTodo);
        
        // Start App
        initApp();
        updateDateTime();

    </script>
</body>
</html>
